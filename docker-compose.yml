services:
  postgres:
    image: postgres:16
    container_name: edu_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-atg}
      POSTGRES_USER: ${POSTGRES_USER:-atg}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-atg}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./backend_django/docker/postgres/001_extensions.sql:/docker-entrypoint-initdb.d/001_extensions.sql:ro
      - ./migrations/complete_database_schema.sql:/docker-entrypoint-initdb.d/002_schema.sql:ro
    networks:
      - edu_network

  redis:
    image: redis:7
    container_name: edu_redis
    ports:
      - "6379:6379"
    networks:
      - edu_network

  minio:
    image: minio/minio:RELEASE.2024-10-13T13-34-11Z
    container_name: edu_minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - miniodata:/data
    networks:
      - edu_network

  minio-init:
    image: minio/mc:RELEASE.2024-10-11T00-39-54Z
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      until (/usr/bin/mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD}); do sleep 1; done;
      /usr/bin/mc mb -p local/$${MINIO_BUCKET} || true;
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-atgedu}
    networks:
      - edu_network

  backend:
    build:
      context: .
      dockerfile: backend_django/docker/Dockerfile
    container_name: edu_backend
    depends_on:
      - postgres
      - redis
      - minio
      - minio-init
    environment:
      DJANGO_DEBUG: ${DJANGO_DEBUG:-1}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-change-me}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-*}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}

      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-change-me-access}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change-me-refresh}
      ACCESS_TTL_SEC: ${ACCESS_TTL_SEC:-900}
      REFRESH_TTL_SEC: ${REFRESH_TTL_SEC:-1209600}

      POSTGRES_DB: ${POSTGRES_DB:-atg}
      POSTGRES_USER: ${POSTGRES_USER:-atg}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-atg}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432

      MINIO_ENDPOINT: http://minio:9000
      MINIO_BUCKET: ${MINIO_BUCKET:-atgedu}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "8000:8000"
    networks:
      - edu_network

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: edu_frontend
    depends_on:
      - backend
    ports:
      - "3000:80"
    networks:
      - edu_network

networks:
  edu_network:
    driver: bridge

volumes:
  pgdata:
  miniodata:











